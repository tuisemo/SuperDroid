---
name: plan-critique-fix
description: 批评PLAN.md进度，识别阻塞点，提出下一步精确行动。
---

输入：当前PLAN.md内容 + git diff --shortstat + failure.log（如果有的话）+ 最近supervisor状态

输出格式：
CRITIQUE_SUMMARY: ...
BLOCKERS: - 阻塞点1\n- 阻塞点2
PROGRESS_GAPS: ...
NEXT_ACTIONS:
  - DELEGATE:coder "精确任务描述"
  - USE_SKILL:auto-test-and-fix
  - DELEGATE:tester "运行特定测试"
REPLAN_NEEDED: yes/no

## 新增功能

### 风险评估 (Risk Assessment)
评估项目中的各种风险类型：

#### 技术风险
- **架构复杂度**：系统是否过于复杂？
- **技术债务**：是否存在需要重构的代码？
- **性能瓶颈**：是否有可能的性能问题？
- **安全性**：是否存在安全漏洞或弱点？

#### 进度风险
- **时间估算**：原始估算是否合理？
- **依赖关系**：是否有外部依赖可能延迟？
- **人员可用性**：团队成员是否可用？
- **范围蔓延**：需求是否频繁变化？

#### 资源风险
- **计算资源**：CPU、内存、存储是否充足？
- **网络带宽**：网络容量是否足够？
- **第三方服务**：API限制、配额问题？
- **预算限制**：是否超出预算？

### 资源估算 (Resource Estimation)
评估完成任务所需的资源：

#### 时间估算
- **乐观估算**：最佳情况下的时间
- **现实估算**：最可能的时间
- **悲观估算**：最坏情况下的时间
- **缓冲时间**：预留的应急时间

#### 人力估算
- **开发人员**：所需的开发人数和技能水平
- **测试人员**：测试工作量评估
- **运维人员**：部署和维护工作
- **专家顾问**：是否需要外部专家？

#### 依赖估算
- **外部服务**：依赖的第三方服务
- **库和框架**：依赖的第三方库
- **内部模块**：依赖的其他内部模块
- **数据源**：依赖的数据存储或API

### 依赖分析 (Dependency Analysis)
分析项目中的依赖关系：

#### 直接依赖
- **代码依赖**：模块之间的调用关系
- **数据依赖**：数据流和依赖关系
- **服务依赖**：微服务之间的依赖
- **库依赖**：第三方库的依赖版本

#### 间接依赖
- **传递依赖**：依赖的依赖
- **隐式依赖**：不明显但存在的依赖
- **环境依赖**：操作系统、运行时依赖
- **配置依赖**：配置文件和环境变量

#### 依赖图
```
[使用 Mermaid 生成依赖关系图]

graph TD
    A[模块A] --> B[模块B]
    A --> C[模块C]
    B --> D[模块D]
    C --> D
    D --> E[外部服务]
```

### 回滚策略 (Rollback Strategies)
如果出现问题时的恢复方案：

#### 代码回滚
- **Git回滚**：使用 `git revert` 或 `git reset`
- **版本标记**：标记可回滚的版本点
- **回滚脚本**：自动化回滚脚本
- **数据恢复**：数据库迁移回滚

#### 部署回滚
- **蓝绿部署**：切换回旧版本
- **金丝雀发布**：逐步回滚
- **配置恢复**：恢复旧的配置
- **服务重启**：重启稳定的服务

#### 数据回滚
- **数据库备份**：使用备份恢复
- **迁移回滚**：反向执行迁移脚本
- **数据验证**：验证数据完整性
- **增量修复**：部分数据修复

#### 回滚决策树
```
如果部署失败：
  └─> 检查错误类型
      ├─> 配置错误 ──> 更新配置并重试
      ├─> 代码错误 ──> 回滚到上一版本
      ├─> 数据错误 ──> 执行数据修复
      └─> 环境错误 ──> 修复环境或切换环境
```

### 改进的输出格式
更新后的输出应包含新部分：

```
CRITIQUE_SUMMARY: ...
BLOCKERS:
  - 阻塞点1
  - 阻塞点2

PROGRESS_GAPS: ...

## 风险评估 (Risk Assessment)

### 技术风险
- [风险1]: [严重性: 高/中/低] - [影响描述]
- [风险2]: [严重性: 高/中/低] - [影响描述]

### 进度风险
- [风险1]: [严重性: 高/中/低] - [影响描述]
- [风险2]: [严重性: 高/中/低] - [影响描述]

### 资源风险
- [风险1]: [严重性: 高/中/低] - [影响描述]
- [风险2]: [严重性: 高/中/低] - [影响描述]

## 资源估算 (Resource Estimation)

### 时间估算
- 乐观: [X天]
- 现实: [X天]
- 悲观: [X天]
- 缓冲: [X天]

### 人力估算
- 开发: [人数/角色]
- 测试: [人数/角色]
- 运维: [人数/角色]

### 依赖估算
- 外部服务: [列表]
- 第三方库: [列表]
- 内部模块: [列表]

## 依赖分析 (Dependency Analysis)

### 依赖关系图
[MERMAID依赖图]

### 关键依赖
- [依赖1]: [重要性/风险]
- [依赖2]: [重要性/风险]

### 依赖评估
- [模块/服务]: [依赖度/影响]

## 回滚策略 (Rollback Strategies)

### 代码回滚
- 回滚方法: [描述]
- 可回滚版本: [标签/哈希]

### 部署回滚
- 回滚方式: [蓝绿/金丝雀/手动]
- 回滚命令: [命令]

### 数据回滚
- 备份策略: [描述]
- 恢复方法: [描述]

## NEXT_ACTIONS

### 代码相关
  - DELEGATE:coder "精确任务描述"

### 测试相关
  - DELEGATE:tester "运行特定测试"
  - USE_SKILL:auto-test-and-fix

### 其他
  - [其他行动]

REPLAN_NEEDED: yes/no

RECOMMENDATION: [总体建议]
```
